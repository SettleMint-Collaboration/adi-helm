{{- if .Values.proofSync.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "adi-stack.fullname" . }}-sync-script
  labels:
    {{- include "adi-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: proof-sync
  {{- with (include "adi-stack.annotations" .) }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
data:
  sync-proofs.sh: |
    #!/bin/sh
    set -e

    PROOF_STORAGE_URL="${PROOF_STORAGE_URL:-https://adiproofs.blob.core.windows.net/shared}"
    SHARED_PROOF_DIR="${SHARED_PROOF_DIR:-/chain/db/shared}"
    SYNC_INTERVAL="${SYNC_INTERVAL:-60}"
    DELETE_DESTINATION="${DELETE_DESTINATION:-false}"

    echo "Starting proof sync service..."
    echo "Source: ${PROOF_STORAGE_URL}"
    echo "Destination: ${SHARED_PROOF_DIR}"
    echo "Interval: ${SYNC_INTERVAL}s"
    echo "Delete destination: ${DELETE_DESTINATION}"

    # Ensure destination directory exists
    mkdir -p "${SHARED_PROOF_DIR}"

    while true; do
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting sync..."

        AZCOPY_ARGS="--recursive"
        if [ "${DELETE_DESTINATION}" = "true" ]; then
            AZCOPY_ARGS="${AZCOPY_ARGS} --delete-destination=true"
        fi

        if azcopy sync "${PROOF_STORAGE_URL}" "${SHARED_PROOF_DIR}" ${AZCOPY_ARGS}; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Sync completed successfully"
        else
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Sync failed, will retry on next interval"
        fi

        echo "$(date '+%Y-%m-%d %H:%M:%S') - Sleeping for ${SYNC_INTERVAL}s..."
        sleep "${SYNC_INTERVAL}"
    done
{{- end }}
